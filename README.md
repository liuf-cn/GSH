# GSH:Gene-based stepwise haplotype method

### Software Introduction
This software is developed based on R language, with the core function of conducting Genome-Wide Association Studies (GWAS) using haplotype data. It adopts a Mixed Linear Model (MLM) to control population structure and kinship, supports input of genotype, phenotype, and gene annotation files, and outputs haplotype and allele association analysis results. It is suitable for genetic mapping studies of crops such as maize and wheat.  
Haplotype Construction and Association Analysis  
Divide SNP windows according to gene regions, and construct haplotypes from SNP combinations within each window (2-SNP or 3-SNP combinations)  
Use stepwise regression (stepAIC) to screen for optimal SNP combinations  
Test the significance of haplotype effects through analysis of variance (ANOVA)  
Output haplotype-level and allele-level association results  
## Software Dependencies   
1. Operating Environment  
Operating System: Linux/Unix (recommended), Windows (path format needs adjustment)  
R Version: ≥4.0.0  
2. Required R Packages  
install.packages(c("data.table", "BGLR", "MASS", "parallel"))  

## Input File Description
1. Genotype File (Core Input)  
Format: .hap.raw format generated by PLINK (haplotype data)  
Path Requirement: Must be placed in the ld90/ directory, with the file name format chrX.hap.raw (X is the chromosome number, e.g., chr1.hap.raw)  
Content Description: The first column is individual ID (FID), and subsequent columns are genotype data of each haplotype marker (0/2 encoding)  
2. Phenotype File  
File Name: phenotype.txt (fixed name)  
Format: Tab-separated text file, the first column is individual ID (must be consistent with FID in the genotype file), and subsequent columns are phenotypic traits (e.g., plant height PH, disease resistance, etc.)  
Example:  
FID     PH      YR      PW  
Line1   150.2   3.0     25.1  
Line2   145.8   2.5     23.7  
3. Gene Annotation File  
File Name: gene.gff3 (fixed name)  
Format: Standard GFF3 format, including at least chromosome number (Column 1), gene start position (Column 4), and gene end position (Column 5)  
Example:  
chr1    RefSeq  gene    1000    5000    .       +       .       ID=gene1  
chr1    RefSeq  gene    6000    10000   .       -       .       ID=gene2  
4. population kinship matrix  
Kinship Matrix File: kin_gemma.cXX.txt (population kinship matrix)  
Example:  
Line1   1   0.3     0.6  
Line2   0.3   1     0.5  

## Output File Description
### 1. Core Result File  
[trait_name]_hap_step.txt: Summary results of haplotype association analysis, including the following columns:  
Number: Gene serial number  
hap: SNP combination corresponding to the haplotype (e.g., SNP1_SNP2_SNP3)  
chr: Chromosome number  
pos: Average physical position of the haplotype (bp)  
pvalue_hap: Haplotype-level association P-value  
pvalue_allele: Minimum allele-level P-value  
r2: Adjusted R² of the model (explanatory power)  
### 2. Intermediate Result Files  
GWAS/[trait_name]_sgene/chrX_hap_m: Raw haplotype analysis data of each gene on each chromosome (X is the chromosome number, m is the gene serial number)  
[trait_name]_hap_step.txt: Summary results of all chromosomes  

# Usage Steps
## 1. Preparation
Organize input files as required to ensure file names and paths comply with specifications:
plaintext
Working Directory/
├── ld90/                # Genotype file directory
│   ├── chr1.hap.raw
│   ├── chr2.hap.raw
│   └── ...
├── phenotype.txt        # Phenotype file
├── gene.gff3            # Gene annotation file
├── hybrid_allchr_ld90.bim  # Genetic map file
├── kin_gemma.cXX.txt    # Kinship matrix file
├── hap_alleles.txt      # 3-SNP haplotype allele file
└── hap2_alleles.txt     # 2-SNP haplotype allele file
## 2. Parameter Configuration
Modify the following parameters in the main software script (gwas_haplotype.R) according to actual data:
## 1. Trait name (must be consistent with the column name in the phenotype file)
trait <- "PH"  # Example: Plant Height (PH)
## 2. Chromosome number (multiple chromosomes can be run in a loop)
chr <- "chr1"
## 3. Variance components (set according to BGLR analysis results or literature)
var.geno <- 771.992  # Genetic variance
var.err <- 43.76611  # Residual variance
## 4. Haplotype window setting (SNP combination window size)
windowsize <- 100000  # Inter-gene window size (bp), used to divide SNP-specific gene regions
## 5. Number of parallel computing cores
N_CPU_CORE <- 4  # Adjust according to the server's CPU core count

## Run the Software
Method 1: Directly Run R Script
Run in R console  
source("gwas_haplotype.R")  
Method 2: Run in Linux Command Line (Recommended, supports background running)  
Run in background, output logs to nohup.out  
nohup R CMD BATCH gwas_haplotype.R &  
Method 3: Run Multiple Chromosomes in a Loop  
Write a Shell script to run 22 chromosomes in a loop (example)  
for chr in {1..22}; do  
  R CMD BATCH --args chr$chr PH 4 gwas_haplotype.R  
done  

## Core Algorithm Description
## 1. Mixed Linear Model Adjustment
The VanRaden method is used to calculate the kinship matrix (K), and the mixed linear model is transformed into a simple linear model through eigenvalue decomposition to control false positives caused by population structure and kinship:
plaintext
Y = Xβ + Zu + e
Y: Phenotype value vector
X: Fixed effect matrix (haplotype)
β: Fixed effect coefficient (haplotype effect)
Z: Random effect design matrix
u: Random effect vector (genetic background), following N(0, Kσₐ²)
e: Residual vector, following N(0, Iσₑ²)
## 2. Haplotype Construction and Association Analysis
Divide SNP windows according to gene regions, and construct haplotypes from SNP combinations within each window (2-SNP or 3-SNP combinations)
Use stepwise regression (stepAIC) to screen for optimal SNP combinations
Test the significance of haplotype effects through analysis of variance (ANOVA)
Output haplotype-level and allele-level association results
## Notes
Individual IDs in input files must be consistent: The individual order and IDs in the genotype file, phenotype file, and kinship matrix must be completely matched.  
Variance component setting: var.geno and var.err are recommended to be estimated by BGLR software (relevant code in the script is commented and can be run directly for estimation). If there is a lack of prior information, refer to similar studies on the same species.  
Parallel computing: N_CPU_CORE should not exceed the actual number of server cores to avoid memory overflow.  
Data format check: Before running, verify that there are no missing values in the genotype file and that the SNP position information is correct (can be checked with head and summary commands).  
Result interpretation: P-values need to be corrected for multiple tests (e.g., Bonferroni correction), and it is recommended to combine Manhattan plots and QQ plots to further screen significantly associated haplotypes.  
### Common Problem Troubleshooting  
"Individual ID mismatch" error: Check the result of geno[,1]==pheno[,1] to ensure the individual order in the genotype and phenotype files is consistent.  
"SNP count is 0" warning: Check the chromosome number format of the gene annotation file (e.g., "chr1" or "1") to ensure consistency with the genotype file.  
Slow running speed: Reduce windowsize, decrease the number of parallel cores, or split chromosomes to run in batches.  
Memory overflow: For large sample data (>1000 individuals), it is recommended to increase server memory (≥16GB) or run by splitting chromosomes and gene regions.  
